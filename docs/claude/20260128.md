# 2026-01-28 作業記録

## 前回からの引き継ぎ

- 前日: 初期セットアップ、ページ実装、機能実装完了
- 問題: Prisma 7 + better-sqlite3 アダプタでランタイムエラー発生
  - `PrismaClientKnownRequestError` が `/dashboard` でスロー
  - build, lint, type-check は通るがランタイムで死ぬ

---

## 本日の作業

### Prisma 6 ダウングレード

Prisma 7 の新しいアダプタシステムが不安定だったため、Prisma 6 に戻した。

**実施内容:**

1. Prisma 7 関連パッケージをアンインストール

   ```bash
   npm uninstall @prisma/adapter-better-sqlite3 better-sqlite3 @types/better-sqlite3 @libsql/client @prisma/adapter-libsql
   ```

2. Prisma 6 をインストール

   ```bash
   npm install prisma@6 @prisma/client@6
   ```

3. `src/lib/prisma.ts` をシンプルな形に戻す

   ```typescript
   import { PrismaClient } from "@prisma/client";

   const globalForPrisma = globalThis as unknown as {
     prisma: PrismaClient | undefined;
   };

   export const prisma = globalForPrisma.prisma ?? new PrismaClient();

   if (process.env.NODE_ENV !== "production") {
     globalForPrisma.prisma = prisma;
   }
   ```

4. `prisma/schema.prisma` に `url` を追加

   ```prisma
   datasource db {
     provider = "sqlite"
     url      = env("DATABASE_URL")
   }
   ```

5. `prisma.config.ts` (Prisma 7 用) を削除

6. Prisma クライアント再生成
   ```bash
   npx prisma generate
   ```

**結果:**

- type-check: OK
- lint: OK
- build: OK

### マイグレーション再適用

ダウングレード後、テーブルが存在しないエラーが出た。

```
The table `main.goals` does not exist in the current database.
```

マイグレーションを再適用して解決。

```bash
npx prisma migrate dev --name prisma6_reset
```

### 現在の状態

- dev サーバー起動中 (http://localhost:3000)
- Google OAuth 設定済み
- ダッシュボード動作確認 OK

### 次のステップ

- [ ] 実際にログインして目標・振り返り機能の動作確認
- [ ] Turso 連携 (本番用)
- [ ] Vercel デプロイ設定
